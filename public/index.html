<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midjourney API Demo</title>
    <style>
        /* CSS ƒê∆°n gi·∫£n - Dark Mode Style */
        :root {
            --bg-color: #1a1b26;
            --card-bg: #24283b;
            --text-color: #c0caf5;
            --primary: #7aa2f7;
            --success: #9ece6a;
            --danger: #f7768e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
        }

        h1 { text-align: center; color: var(--primary); }

        /* Form Style */
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #414868;
            background-color: #16161e;
            color: white;
            box-sizing: border-box; /* Fix l·ªói tr√†n padding */
        }
        
        textarea { height: 80px; resize: vertical; }

        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* Buttons */
        button {
            cursor: pointer;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .btn-primary { background-color: var(--primary); color: #1a1b26; width: 100%; font-size: 16px; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { background-color: #565f89; cursor: not-allowed; }

        .btn-upscale {
            background-color: var(--card-bg);
            border: 1px solid var(--primary);
            color: var(--primary);
            flex: 1;
            margin: 5px;
        }
        .btn-upscale:hover { background-color: var(--primary); color: #1a1b26; }

        /* Result Area */
        .result-area { text-align: center; display: none; }
        .grid-image { 
            width: 100%; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            border: 2px solid #414868;
        }

        .upscale-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .loading { color: var(--primary); font-style: italic; margin-top: 10px; display: none;}
        
        .final-result { margin-top: 30px; border-top: 1px solid #414868; padding-top: 20px; display: none; }
        .final-image { width: 100%; border-radius: 8px; box-shadow: 0 0 20px rgba(122, 162, 247, 0.3); }

        /* Logs */
        #logs { 
            font-family: monospace; 
            font-size: 12px; 
            color: #565f89; 
            margin-top: 10px; 
            white-space: pre-wrap;
        }

        .flux-edit-card {
            margin-top: 20px;
            background-color: var(--card-bg);
            padding: 16px;
            border-radius: 10px;
            border: 1px dashed #414868;
        }

        .flux-edit-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .flux-edit-section-title {
            font-size: 13px;
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 6px;
        }

        .flux-result-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px solid #414868;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin: 10px 0 20px 0;
        }
        .tab-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #414868;
            background: #16161e;
            color: var(--text-color);
            cursor: pointer;
        }
        .tab-btn.active {
            background: var(--primary);
            color: #1a1b26;
            border-color: var(--primary);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üé® Midjourney + FLUX API Tester</h1>

        <div class="tabs">
            <button id="tab-btn-1" class="tab-btn active" onclick="switchTab('tab1')">Tab 1: Generate ‚Üí Upscale ‚Üí Edit FLUX</button>
            <button id="tab-btn-2" class="tab-btn" onclick="switchTab('tab2')">Tab 2: Upload & Edit b·∫±ng FLUX</button>
        </div>

        <!-- TAB 1: Flow Generate -> Upscale -> Edit b·∫±ng FLUX -->
        <div id="tab1" class="tab-content active">
            <div class="card">
                <div class="form-group">
                    <label>Prompt (M√¥ t·∫£ ·∫£nh)</label>
                    <textarea id="prompt" placeholder="Ex: A cute robot working on laptop, cyberpunk style..."></textarea>
                </div>

                <div class="row">
                    <div class="col form-group">
                        <label>Aspect Ratio</label>
                        <select id="aspect_ratio">
                            <option value="16:9">16:9 (Ngang)</option>
                            <option value="9:16">9:16 (D·ªçc)</option>
                            <option value="1:1">1:1 (Vu√¥ng)</option>
                            <option value="4:3">4:3</option>
                        </select>
                    </div>
                    <div class="col form-group">
                        <label>Model</label>
                        <select id="model">
                            <option value="standard">Standard (V7)</option>
                            <option value="v6">Model V6.1</option>
                            <option value="anime">Anime (Niji 6)</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col form-group">
                        <label>Stylize</label>
                        <select id="stylize">
                            <option value="medium">Medium (C√¢n b·∫±ng)</option>
                            <option value="low">Low (Th·ª±c t·∫ø)</option>
                            <option value="high">High (Ngh·ªá thu·∫≠t)</option>
                        </select>
                    </div>
                    <div class="col form-group">
                        <label>Negative Prompt</label>
                        <input type="text" id="negative_prompt" placeholder="Ex: text, watermark, ugly">
                    </div>
                </div>

                <button id="btnGenerate" class="btn-primary" onclick="generateImage()">üöÄ T·∫†O ·∫¢NH (GENERATE)</button>
                <div id="loadingGen" class="loading">‚è≥ ƒêang g·ªçi Bot v·∫Ω (M·∫•t kho·∫£ng 30-60s)... vui l√≤ng ch·ªù ƒë·ª´ng t·∫Øt tab.</div>
                <div id="logs"></div>
            </div>

            <div id="gridResult" class="card result-area">
                <h3>üì∏ K·∫øt qu·∫£ b·∫£n nh√°p (Grid)</h3>
                <img id="imgGrid" class="grid-image" src="" alt="Grid Image">
                
                <p>Ch·ªçn 1 ·∫£nh ƒë·ªÉ Upscale (L√†m n√©t):</p>
                <div class="upscale-controls">
                    <button class="btn-upscale" onclick="upscaleImage(1)">U1 (Tr√™n Tr√°i)</button>
                    <button class="btn-upscale" onclick="upscaleImage(2)">U2 (Tr√™n Ph·∫£i)</button>
                    <button class="btn-upscale" onclick="upscaleImage(3)">U3 (D∆∞·ªõi Tr√°i)</button>
                    <button class="btn-upscale" onclick="upscaleImage(4)">U4 (D∆∞·ªõi Ph·∫£i)</button>
                </div>
                <div id="loadingUpscale" class="loading">‚è≥ ƒêang Upscale (Kho·∫£ng 5-10s)...</div>
            </div>

            <div id="finalResult" class="card result-area final-result">
                <h3 style="color: var(--success)">‚ú® ·∫¢nh ho√†n thi·ªán (HD)</h3>
                <img id="imgFinal" class="final-image" src="" alt="Upscaled Image">
                <p style="margin-top: 10px;"><a id="linkFinal" href="#" target="_blank" style="color: var(--primary)">M·ªü link g·ªëc</a></p>

                <!-- Khu v·ª±c ch·ªânh s·ª≠a ·∫£nh b·∫±ng FLUX (·∫£nh ƒë√£ Upscale) -->
                <div class="flux-edit-card">
                    <div class="flux-edit-title">ü™Ñ Ch·ªânh s·ª≠a ·∫£nh Upscale b·∫±ng FLUX (/generate)</div>
                    <textarea id="flux_edit_prompt" placeholder="V√≠ d·ª•: add him a hat, change background to beach..."></textarea>
                    <button class="btn-primary" style="margin-top: 8px;" onclick="editUpscaledWithFlux()">
                        ‚úèÔ∏è S·ª≠a ·∫£nh Upscale b·∫±ng FLUX
                    </button>

                    <div id="flux_loading" class="loading">‚è≥ FLUX ƒëang x·ª≠ l√Ω ·∫£nh... (c√≥ th·ªÉ m·∫•t v√†i ph√∫t)</div>
                    <img id="flux_result_image" class="flux-result-image" src="" alt="Flux Edited Image" style="display:none;">
                </div>
            </div>
        </div>

        <!-- TAB 2: Upload ·∫£nh b·∫•t k·ª≥ r·ªìi ch·ªânh b·∫±ng FLUX -->
        <div id="tab2" class="tab-content">
            <div class="card">
                <h3 style="color: var(--primary)">üì§ Upload ·∫£nh & ch·ªânh b·∫±ng FLUX (/generate_upload)</h3>
                <div class="form-group">
                    <label>Ch·ªçn ·∫£nh</label>
                    <input type="file" id="flux2_file" accept="image/*" onchange="previewUploadedImage(event)">
                </div>
                <div id="flux2_preview_container" style="display: none; margin-bottom: 15px;">
                    <label>·∫¢nh ƒë√£ ch·ªçn:</label>
                    <img id="flux2_preview_image" class="grid-image" src="" alt="Preview Image" style="max-height: 400px; object-fit: contain;">
                </div>
                <div class="form-group">
                    <label>Prompt ch·ªânh s·ª≠a</label>
                    <textarea id="flux2_prompt" placeholder="V√≠ d·ª•: remove background, put a coat on him..."></textarea>
                </div>
                <button class="btn-primary" onclick="editUploadedWithFluxTab2()">üì§ Upload & S·ª≠a b·∫±ng FLUX</button>
                <div id="flux2_loading" class="loading">‚è≥ FLUX ƒëang x·ª≠ l√Ω ·∫£nh... (c√≥ th·ªÉ m·∫•t v√†i ph√∫t)</div>
                <img id="flux2_result_image" class="flux-result-image" src="" alt="Flux Edited Image" style="display:none;">
            </div>
        </div>
    </div>

    <script>
        // C·∫§U H√åNH URL API (N·∫øu ch·∫°y local th√¨ ƒë·ªÉ localhost:3000)
        const API_BASE_URL = '/api/v1';              // Node.js Midjourney server
        const FLUX_BASE_URL = 'http://localhost:6678'; // FastAPI FLUX server

        // Bi·∫øn l∆∞u t·∫°m th√¥ng tin ƒë·ªÉ d√πng cho b∆∞·ªõc Upscale / Edit
        let currentMessageId = null;
        let currentHash = null;
        let currentUpscaledUrl = null; // URL ·∫£nh ƒë√£ upscale (t·ª´ server.js) ƒë·ªÉ g·ª≠i sang FLUX

        function log(msg) {
            const logDiv = document.getElementById('logs');
            logDiv.innerText = `> ${msg}`;
            console.log(msg);
        }

        function switchTab(tab) {
            const tab1 = document.getElementById('tab1');
            const tab2 = document.getElementById('tab2');
            const btn1 = document.getElementById('tab-btn-1');
            const btn2 = document.getElementById('tab-btn-2');

            if (tab === 'tab1') {
                tab1.classList.add('active');
                tab2.classList.remove('active');
                btn1.classList.add('active');
                btn2.classList.remove('active');
            } else {
                tab2.classList.add('active');
                tab1.classList.remove('active');
                btn2.classList.add('active');
                btn1.classList.remove('active');
            }
        }

        // --- B∆Ø·ªöC 1: G·ªåI API GENERATE ---
        async function generateImage() {
            const prompt = document.getElementById('prompt').value;
            if (!prompt) return alert("Vui l√≤ng nh·∫≠p Prompt!");

            // UI Update
            document.getElementById('btnGenerate').disabled = true;
            document.getElementById('loadingGen').style.display = 'block';
            document.getElementById('gridResult').style.display = 'none';
            document.getElementById('finalResult').style.display = 'none';
            log("ƒêang g·ª≠i y√™u c·∫ßu t·∫°o ·∫£nh...");

            try {
                const payload = {
                    prompt: prompt,
                    aspect_ratio: document.getElementById('aspect_ratio').value,
                    model: document.getElementById('model').value,
                    stylize: document.getElementById('stylize').value,
                    negative_prompt: document.getElementById('negative_prompt').value
                };

                const response = await fetch(`${API_BASE_URL}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    log("T·∫°o ·∫£nh th√†nh c√¥ng!");
                    // Hi·ªÉn th·ªã ·∫£nh Grid
                    document.getElementById('imgGrid').src = data.data.grid_image_url;
                    document.getElementById('gridResult').style.display = 'block';
                    
                    // L∆∞u l·∫°i ID v√† Hash ƒë·ªÉ d√πng cho Upscale
                    currentMessageId = data.data.message_id;
                    currentHash = data.data.hash;
                } else {
                    alert("L·ªói: " + (data.error || "Kh√¥ng x√°c ƒë·ªãnh"));
                    log("L·ªói: " + JSON.stringify(data));
                }

            } catch (error) {
                alert("L·ªói k·∫øt n·ªëi Server!");
                log("Exception: " + error);
            } finally {
                document.getElementById('btnGenerate').disabled = false;
                document.getElementById('loadingGen').style.display = 'none';
            }
        }

        // --- B∆Ø·ªöC 2: G·ªåI API UPSCALE ---
        async function upscaleImage(index) {
            if (!currentMessageId || !currentHash) return alert("Thi·∫øu th√¥ng tin ·∫£nh g·ªëc!");

            // UI Update
            document.getElementById('loadingUpscale').style.display = 'block';
            document.getElementById('finalResult').style.display = 'none';
            
            try {
                const payload = {
                    message_id: currentMessageId,
                    hash: currentHash,
                    index: index
                };

                const response = await fetch(`${API_BASE_URL}/upscale`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Hi·ªÉn th·ªã ·∫£nh Final
                    document.getElementById('imgFinal').src = data.data.upscaled_image_url;
                    document.getElementById('linkFinal').href = data.data.upscaled_image_url;
                    // L∆∞u URL n√†y ƒë·ªÉ g·ª≠i sang FLUX /generate khi user mu·ªën ch·ªânh s·ª≠a
                    currentUpscaledUrl = data.data.upscaled_image_url;
                    document.getElementById('finalResult').style.display = 'block';
                    
                    // Cu·ªôn xu·ªëng xem k·∫øt qu·∫£
                    document.getElementById('finalResult').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert("Upscale th·∫•t b·∫°i: " + data.error);
                }

            } catch (error) {
                alert("L·ªói k·∫øt n·ªëi khi Upscale!");
                console.error(error);
            } finally {
                document.getElementById('loadingUpscale').style.display = 'none';
            }
        }

        // --- B∆Ø·ªöC 3: G·ªåI FLUX API /generate ƒë·ªÉ s·ª≠a ·∫£nh ƒë√£ Upscale ---
        async function editUpscaledWithFlux() {
            if (!currentUpscaledUrl) {
                return alert("Ch∆∞a c√≥ ·∫£nh Upscale ƒë·ªÉ ch·ªânh s·ª≠a! H√£y Generate & Upscale tr∆∞·ªõc.");
            }

            const prompt = document.getElementById('flux_edit_prompt').value.trim();
            if (!prompt) {
                return alert("Vui l√≤ng nh·∫≠p Prompt ch·ªânh s·ª≠a cho FLUX!");
            }

            const loadingEl = document.getElementById('flux_loading');
            const resultImg = document.getElementById('flux_result_image');

            loadingEl.style.display = 'block';
            resultImg.style.display = 'none';

            try {
                log("G·ª≠i ·∫£nh Upscale sang FLUX /generate ƒë·ªÉ ch·ªânh s·ª≠a...");

                const response = await fetch(`${FLUX_BASE_URL}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_url: currentUpscaledUrl,
                        prompt: prompt
                    })
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`FLUX /generate l·ªói: ${response.status} - ${text}`);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                resultImg.src = url;
                resultImg.style.display = 'block';

                log("FLUX ƒë√£ ch·ªânh s·ª≠a xong ·∫£nh Upscale!");
            } catch (err) {
                alert("L·ªói khi g·ªçi FLUX /generate. Xem console/log ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.");
                console.error(err);
                log("L·ªói FLUX /generate: " + err.message);
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // --- PREVIEW ·∫¢NH ƒê√É UPLOAD (Tab 2) ---
        function previewUploadedImage(event) {
            const file = event.target.files[0];
            const previewContainer = document.getElementById('flux2_preview_container');
            const previewImage = document.getElementById('flux2_preview_image');

            if (file) {
                // T·∫°o URL t·∫°m th·ªùi ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
            }
        }

        // --- B∆Ø·ªöC 4: G·ªåI FLUX API /generate_upload ƒë·ªÉ upload & s·ª≠a ·∫£nh b·∫•t k·ª≥ ---
        async function editUploadedWithFlux() {
            // Gi·ªØ ƒë·ªÉ t∆∞∆°ng th√≠ch n·∫øu n∆°i kh√°c g·ªçi, nh∆∞ng ∆∞u ti√™n Tab 2 m·ªõi
            return editUploadedWithFluxTab2();
        }

        // --- B∆Ø·ªöC 4: G·ªåI FLUX API /generate_upload ƒë·ªÉ upload & s·ª≠a ·∫£nh (Tab 2) ---
        async function editUploadedWithFluxTab2() {
            const fileInput = document.getElementById('flux2_file');
            const prompt = document.getElementById('flux2_prompt').value.trim();

            if (!fileInput.files || fileInput.files.length === 0) {
                return alert("Vui l√≤ng ch·ªçn 1 file ·∫£nh ƒë·ªÉ upload!");
            }
            if (!prompt) {
                return alert("Vui l√≤ng nh·∫≠p Prompt ch·ªânh s·ª≠a cho FLUX (upload)!");
            }

            const loadingEl = document.getElementById('flux2_loading');
            const resultImg = document.getElementById('flux2_result_image');

            loadingEl.style.display = 'block';
            resultImg.style.display = 'none';

            try {
                log("ƒêang upload ·∫£nh l√™n FLUX /generate_upload ƒë·ªÉ ch·ªânh s·ª≠a...");

                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('file', fileInput.files[0]);

                const response = await fetch(`${FLUX_BASE_URL}/generate_upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`FLUX /generate_upload l·ªói: ${response.status} - ${text}`);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                resultImg.src = url;
                resultImg.style.display = 'block';

                log("FLUX ƒë√£ ch·ªânh s·ª≠a xong ·∫£nh upload!");
            } catch (err) {
                alert("L·ªói khi g·ªçi FLUX /generate_upload. Xem console/log ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.");
                console.error(err);
                log("L·ªói FLUX /generate_upload: " + err.message);
            } finally {
                loadingEl.style.display = 'none';
            }
        }
    </script>
</body>
</html>